<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Zama fhEVM Simulator - Final</title>
<style>
  :root {
    /* ZAMA COLORS */
    --bg-page: #ffd503; 
    --panel-dark: #151a23;
    --node-bg: rgba(20, 20, 25, 0.98);
    
    /* ACCENTS */
    --zama-blue: #007aff;
    --danger: #ff4d4d;
    --neon-green: #00ff9d;
    --neon-orange: #ff9f1c; 
    
    --font: 'Inter', system-ui, -apple-system, sans-serif;
  }
  
  * { box-sizing: border-box; }

  body { 
    margin: 0; background: var(--bg-page); color: #000; 
    font-family: var(--font); height: 100vh; overflow: hidden; 
    display: flex; flex-direction: column; 
  }
  
  /* HEADER */
  header { 
    flex-shrink: 0; padding: 0 25px; border-bottom: 4px solid #000; 
    display: flex; justify-content: space-between; align-items: center; 
    background: var(--bg-page); z-index: 1000; height: 70px;
  }
  
  .branding { display: flex; align-items: center; gap: 12px; flex: 1; }
  .zama-logo { 
    height: 35px; width: auto; display: block; mix-blend-mode: multiply; 
    border: 1px solid #000; /* Fallback visibility */
  }
  h1 { margin: 0; font-size: 22px; font-weight: 900; letter-spacing: -0.5px; text-transform: uppercase; }

  /* DISCLAIMER SECTION */
  .disclaimer {
    flex: 2; text-align: center; font-size: 11px; line-height: 1.3; color: #333;
    border-left: 1px solid rgba(0,0,0,0.1); border-right: 1px solid rgba(0,0,0,0.1);
    padding: 0 15px; font-weight: 500;
  }
  .disclaimer a {
    color: #000; font-weight: 800; text-decoration: underline; transition: color 0.2s;
  }
  .disclaimer a:hover { color: var(--zama-blue); }
  
  /* MODE SWITCH */
  .mode-wrapper { flex: 1; display: flex; justify-content: flex-end; }
  .mode-switch { display: flex; background: rgba(0,0,0,0.1); border: 2px solid #000; border-radius: 24px; padding: 4px; gap: 4px; }
  .mode-btn { 
    padding: 8px 20px; border-radius: 20px; font-size: 11px; font-weight: 800; cursor: pointer; 
    transition: all 0.2s ease; color: #555; border: none; background: transparent; outline: none; text-transform: uppercase;
  }
  .mode-btn:hover { color: #000; background: rgba(255,255,255,0.4); }
  .mode-btn.active-std { background: var(--danger); color: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
  .mode-btn.active-zama { background: #000; color: var(--bg-page); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
  .mode-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

  /* LAYOUT */
  .layout { display: grid; grid-template-columns: 1fr 420px; flex: 1; overflow: hidden; }
  
  /* CANVAS */
  .canvas-wrapper { 
    position: relative; background: radial-gradient(circle at 50% 50%, #2a2a2a 0%, #000000 100%); 
    overflow: hidden; border-right: 4px solid #000; display: flex; align-items: center; justify-content: center;
  }
  svg { width: 100%; height: 100%; pointer-events: none; } 
  
  /* TEACHING OVERLAY */
  .teaching-box {
    position: absolute; top: 15px; left: 50%; transform: translateX(-50%);
    background: #000; border: 3px solid var(--bg-page); padding: 12px 25px; 
    border-radius: 12px; width: 80%; max-width: 600px; text-align: center; 
    box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 50;
  }
  .teaching-title { color: var(--bg-page); font-size: 11px; font-weight: 900; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; }
  .teaching-text { color: #fff; font-size: 15px; line-height: 1.3; font-weight: 600; }

  /* CONTROLS */
  .controls { 
    background: var(--panel-dark); padding: 20px; display: flex; flex-direction: column; 
    gap: 15px; z-index: 60; box-shadow: -10px 0 40px rgba(0,0,0,0.5); border-left: 4px solid #000; overflow-y: auto; 
  }
  .step-card { background: #000; padding: 15px; border-radius: 8px; border: 1px solid #333; flex-shrink: 0; }
  .step-title { font-size: 13px; font-weight: 700; text-transform: uppercase; margin-bottom: 8px; color: #fff; }
  .step-desc { font-size: 12px; line-height: 1.4; color: #ccc; }
  
  button.action-btn { 
    background: #333; border: 1px solid #555; padding: 15px; border-radius: 8px; 
    color: #fff; font-weight: 800; cursor: pointer; transition: transform 0.1s; width: 100%; font-size: 13px; text-transform: uppercase;
  }
  button.btn-zama { background: var(--bg-page); color: #000; border: 2px solid #000; }
  button.btn-std { background: var(--danger); color: #fff; border: 2px solid #000; }
  button.btn-pause { background: #fff; color:#000; border: 2px solid #000; }
  button.btn-pause.paused { background: #000; color: #fff; border-color: #fff; animation: blink 1s infinite; }
  button:hover { transform: translateY(-2px); filter: brightness(1.1); }
  button:disabled { background: #333; color: #777; filter: grayscale(1); border-color: #444; cursor: not-allowed; }

  .log-terminal { 
    flex: 1; background: #000; border-radius: 8px; border: 1px solid #333; 
    padding: 15px; font-family: 'Courier New', monospace; font-size: 14px; line-height: 1.5; color: var(--neon-green); overflow-y: auto; 
  }
  .log-entry { margin-bottom: 8px; border-bottom: 1px solid #222; padding-bottom: 4px; }
  .highlight-red { color: var(--danger); font-weight: bold; }
  .highlight-yellow { color: var(--bg-page); font-weight: bold; }

  /* SVG STYLES */
  .node-rect { fill: var(--node-bg); stroke: #555; stroke-width: 2; transition: all 0.3s ease; }
  .node-rect.active-zama { stroke: var(--bg-page); stroke-width: 4; filter: drop-shadow(0 0 15px rgba(255, 213, 3, 0.6)); }
  .node-rect.active-std { stroke: var(--danger); stroke-width: 4; filter: drop-shadow(0 0 15px rgba(255, 77, 77, 0.6)); }
  .node-rect.active-mid { stroke: var(--neon-orange); stroke-width: 3; filter: drop-shadow(0 0 10px rgba(255, 159, 28, 0.5)); }
  .txt-label { fill: #fff; font-size: 14px; font-weight: 800; font-family: monospace; pointer-events: none; }
  .txt-detail { fill: #aaa; font-size: 10px; font-family: monospace; pointer-events: none; }
  .packet { stroke: #fff; stroke-width: 2; opacity: 0; }
  .packet-text { fill: #000; font-size: 10px; font-weight: 900; text-anchor: middle; opacity: 0; pointer-events: none; }
  .link { fill: none; stroke: #444; stroke-width: 2; stroke-dasharray: 6 6; opacity: 0.2; transition: opacity 0.5s; }
  .link.relevant { opacity: 1; stroke: #888; }

  /* FOOTER */
  footer {
    flex-shrink: 0;
    background: #000;
    color: #888;
    padding: 10px;
    text-align: center;
    font-size: 11px;
    border-top: 2px solid #222;
    z-index: 100;
    letter-spacing: 0.5px;
  }
  footer a { color: var(--bg-page); text-decoration: none; font-weight: 700; transition: opacity 0.2s; }
  footer a:hover { opacity: 0.8; text-decoration: underline; }
  .heart { color: var(--danger); font-size: 14px; vertical-align: middle; }

  /* MODAL */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; 
    justify-content: center; align-items: center; z-index: 99999; 
  }
  .modal-content {
    background: #151a23; border: 4px solid var(--bg-page); border-radius: 16px; 
    width: 90%; max-width: 600px; max-height: 90vh; padding: 30px; 
    display: flex; flex-direction: column; box-shadow: 0 0 80px rgba(0,0,0,0.8); 
    transform: scale(0.9); opacity: 0; transition: all 0.3s ease;
  }
  .modal-overlay.show-modal .modal-content { transform: scale(1); opacity: 1; }
  .modal-header { font-size: 22px; font-weight: 800; margin-bottom: 15px; color: #fff; }
  .modal-body { font-size: 15px; line-height: 1.7; color: #ddd; overflow-y: auto; }
  .modal-list { margin-top: 10px; padding-left: 20px; border-left: 3px solid #555; }
  .modal-list li { margin-bottom: 10px; }
  .modal-btn { margin-top: 20px; width: 100%; padding: 16px; font-size: 14px; font-weight: 900; border-radius: 8px; cursor: pointer; background: var(--bg-page); color: #000; border: none; text-transform: uppercase; }

  /* FINAL OVERLAY */
  #final-overlay {
    background: rgba(0,0,0,0.85);
    display: none; flex-direction: column;
    z-index: 99990; 
  }
  .final-content { text-align: center; color: #fff; }
  .final-title { font-size: 30px; font-weight: 900; margin-bottom: 20px; color: var(--bg-page); }
  .final-btn { 
    padding: 20px 40px; font-size: 18px; font-weight: 900; 
    background: transparent; border: 3px solid var(--bg-page); color: var(--bg-page);
    border-radius: 50px; cursor: pointer; transition: all 0.3s; text-transform: uppercase;
  }
  .final-btn:hover { background: var(--bg-page); color: #000; box-shadow: 0 0 30px var(--bg-page); }

  @media (max-width: 900px) {
    .layout { grid-template-columns: 1fr; grid-template-rows: 50vh 1fr; }
    .canvas-wrapper { border-right: none; border-bottom: 4px solid #000; }
    .controls { border-left: none; }
    .disclaimer { display: none; } 
  }
</style>
</head>
<body>

<header>
  <div class="branding">
    <img src="logo.jpg" alt="Zama Logo" class="zama-logo" onerror="this.style.backgroundColor='white'" />
    <h1>Zama <span>Fhevm Simulator</span></h1>
  </div>
  
  <div class="disclaimer">
    This Simulation is based on the <a href="https://github.com/zama-ai/fhevm/blob/main/fhevm-whitepaper.pdf" target="_blank">Technical Whitepaper</a> from Zama.<br>There may be error in the simulation.
  </div>

  <div class="mode-wrapper">
    <div class="mode-switch">
      <button id="mode-std" class="mode-btn" onclick="app.setMode('std')">Public</button>
      <button id="mode-zama" class="mode-btn active-zama" onclick="app.setMode('zama')">Zama (Secure)</button>
    </div>
  </div>
</header>

<div class="layout">
  <div class="canvas-wrapper">
    <div class="teaching-box" id="teach-box">
      <div class="teaching-title">STATUS</div>
      <div class="teaching-text" id="teach-text">System Idle. Select mode & Start.</div>
    </div>

    <svg id="simSvg" viewBox="0 0 1000 700" preserveAspectRatio="xMidYMid meet">
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#888" /></marker>
      </defs>

      <g transform="translate(0, 0)">
        <path id="l-usr-rel" class="link relevant" d="M100 550 L 200 550" />
        <path id="l-rel-gw" class="link relevant" d="M300 550 L 480 550" />
        <path id="l-rel-host" class="link relevant" d="M250 510 C 250 200, 150 200, 150 180" />
        <path id="l-host-cp" class="link relevant" d="M250 130 L 580 130" />
        <path id="l-cp-gw" class="link relevant" d="M680 180 L 680 320 L 650 350" />
        <path id="l-gw-kms" class="link relevant" d="M650 500 L 800 500" />
        <path id="l-gw-orc" class="link relevant" d="M480 450 L 300 420" />
        <path id="l-orc-host" class="link relevant" d="M250 380 C 250 300, 150 300, 150 180" />
        <path id="l-std" class="link" d="M100 550 C 100 150, 100 150, 150 150" />

        <g id="node-host" transform="translate(50, 80)">
          <rect class="node-rect" width="200" height="100" rx="4" />
          <rect class="node-rect" width="200" height="100" rx="4" transform="translate(10,-10)" style="opacity:0.5; z-index:-1" />
          <text x="20" y="40" class="txt-label">Host Chain</text>
          <text id="host-st" x="20" y="70" class="txt-detail">State: -</text>
        </g>
        <g id="node-cp" transform="translate(580, 80)">
          <rect class="node-rect" width="220" height="100" rx="4" />
          <rect class="node-rect" width="220" height="100" rx="4" transform="translate(10,-10)" style="opacity:0.5; z-index:-1" />
          <text x="20" y="40" class="txt-label">Coprocessors</text>
          <rect id="cp-bar" x="20" y="70" width="0" height="6" fill="#00ff9d" />
        </g>
        <g id="node-gw" transform="translate(480, 400)">
          <rect class="node-rect" width="180" height="150" rx="4" />
          <text x="20" y="40" class="txt-label">Gateway</text>
          <text id="gw-st" x="20" y="70" class="txt-detail">Idle</text>
        </g>
        <g id="node-kms" transform="translate(800, 480)">
          <rect class="node-rect" width="160" height="100" rx="4" style="stroke-dasharray:4 4"/>
          <text x="15" y="30" class="txt-label">KMS</text>
          <g transform="translate(10,50)"><circle id="s1" r="8" fill="#333"/><circle id="s2" cx="30" r="8" fill="#333"/><circle id="s3" cx="60" r="8" fill="#333"/></g>
        </g>
        <g id="node-rel" transform="translate(200, 510)">
          <rect class="node-rect" width="100" height="80" rx="4" style="stroke:var(--neon-orange)" />
          <text x="20" y="45" class="txt-label" style="fill:var(--neon-orange)">Relayer</text>
        </g>
        <g id="node-orc" transform="translate(200, 350)">
          <rect class="node-rect" width="100" height="80" rx="4" style="stroke:var(--neon-orange)" />
          <text x="20" y="45" class="txt-label" style="fill:var(--neon-orange)">Oracle</text>
        </g>
        <g id="node-usr" transform="translate(20, 510)">
          <rect class="node-rect" width="80" height="80" rx="8" />
          <text x="20" y="45" class="txt-label">User</text>
        </g>
        <g id="packet-group">
          <circle id="packet-body" class="packet" cx="0" cy="0" r="18" />
          <text id="packet-text" class="packet-text" x="0" y="4">Tx</text>
        </g>
      </g>
    </svg>
  </div>

  <div class="controls">
    <div id="desc-box">
      <div class="step-card">
        <div id="step-title" class="step-title" style="color:var(--bg-page)">ZAMA FHEVM MODE</div>
        <div id="step-desc" class="step-desc">Schematic Flow: User > Relayer > Gateway > Host > Coprocessor > Gateway > KMS > Oracle.</div>
      </div>
    </div>
    
    <div class="btn-control-row">
      <button id="btn-pause" class="action-btn btn-pause" onclick="app.togglePause()">⏸ PAUSE</button>
      <button id="btn-run" class="action-btn btn-zama" onclick="app.runSimulation()">START ZAMA FLOW</button>
    </div>
    
    <div class="log-terminal" id="logger">
      <div class="log-entry">System Ready.</div>
    </div>
  </div>
</div>

<footer>
  Built with <span class="heart">♥</span> for <a href="https://zama.ai" target="_blank">ZAMA</a> &nbsp;|&nbsp; 
  Developer: <a href="https://x.com/lemonar777" target="_blank">@lemonar777</a>
</footer>

<div id="result-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header" id="modal-title">Title</div>
    <div class="modal-body">
      <p id="modal-msg" style="margin-bottom:15px; font-size:16px; color:#fff; font-weight:bold;">Message</p>
      <ul class="modal-list" id="modal-details"></ul>
      <p id="modal-footer" style="margin-top:15px; font-weight:bold; color:#fff; font-size:16px; border-top:1px solid #444; padding-top:10px;"></p>
    </div>
    <button class="modal-btn" id="modal-close" onclick="app.closeModal()">CLOSE</button>
  </div>
</div>

<div id="final-overlay" class="modal-overlay">
  <div class="final-content">
    <div class="final-title">SIMULATION FINISHED</div>
    <button class="final-btn" onclick="app.resetApp()">RESET SIMULATION</button>
  </div>
</div>

<script>
const app = (function() {
  const $ = id => document.getElementById(id);
  const logBox = $('logger');
  const teachText = $('teach-text');
  const modal = $('result-modal');
  const finalOverlay = $('final-overlay');
  
  let isRunning = false;
  let isPaused = false;
  let currentMode = 'zama';
  const SPEED_FACTOR = 2.0;

  function togglePause() {
    if(!isRunning) return;
    isPaused = !isPaused;
    const btn = $('btn-pause');
    btn.innerHTML = isPaused ? "▶ RESUME" : "⏸ PAUSE";
    btn.classList.toggle('paused', isPaused);
  }

  function setMode(m) {
    if(isRunning) return;
    currentMode = m;
    $('mode-std').className = `mode-btn ${m==='std'?'active-std':''}`;
    $('mode-zama').className = `mode-btn ${m==='zama'?'active-zama':''}`;
    
    const btn = $('btn-run');
    if(m==='std') {
      btn.className = 'action-btn btn-std';
      btn.innerText = "START PUBLIC FLOW";
      $('step-title').style.color = "var(--danger)";
      $('step-title').innerText = "PUBLIC BLOCKCHAIN";
      $('step-desc').innerText = "Transparent data. No Relayers/Oracles.";
    } else {
      btn.className = 'action-btn btn-zama';
      btn.innerText = "START ZAMA FLOW";
      $('step-title').style.color = "var(--bg-page)";
      $('step-title').innerText = "ZAMA FHEVM";
      $('step-desc').innerText = "Full architecture with Relayer/Oracle/KMS.";
    }
    resetVisuals();
  }

  function resetVisuals() {
    logBox.innerHTML = '';
    $('host-st').innerText = "State: -";
    $('gw-st').innerText = "Idle";
    $('cp-bar').setAttribute('width', 0);
    document.querySelectorAll('.node-rect').forEach(el => el.classList.remove('active-zama','active-std','active-mid'));
    $('packet-body').style.opacity = 0;
    $('packet-text').style.opacity = 0;
    ['s1','s2','s3'].forEach(id => $(id).style.fill = '#333');
  }

  function resetApp() {
    finalOverlay.style.display = 'none';
    isRunning = false;
    $('btn-run').disabled = false;
    $('btn-run').innerText = "START " + (currentMode==='std'?'PUBLIC':'ZAMA') + " FLOW";
    $('mode-std').disabled = false;
    $('mode-zama').disabled = false;
    resetVisuals();
    explain("System Reset. Ready.");
  }

  function explain(txt) {
    teachText.innerText = txt;
    teachText.style.animation = 'none';
    teachText.offsetHeight;
    teachText.style.animation = 'fadeIn 0.5s';
  }

  function log(msg, type) {
    const div = document.createElement('div');
    div.className = 'log-entry';
    if(type==='err') div.style.color = 'var(--danger)';
    if(type==='zama') div.style.color = 'var(--bg-page)';
    div.innerText = `> ${msg}`;
    $('logger').appendChild(div);
    $('logger').scrollTop = $('logger').scrollHeight;
  }

  function wait(ms) {
    return new Promise(resolve => {
      const total = ms * SPEED_FACTOR;
      let elapsed = 0;
      const timer = setInterval(() => {
        if(!isPaused) elapsed += 50;
        if(elapsed >= total) {
          clearInterval(timer);
          resolve();
        }
      }, 50);
    });
  }

  function movePacket(pathId, label, color, duration=1000) {
    return new Promise(resolve => {
      const path = $(pathId);
      if(!path) { console.error("Missing Path:", pathId); resolve(); return; }
      
      const len = path.getTotalLength();
      const body = $('packet-body');
      const text = $('packet-text');
      body.style.opacity = 1; body.style.fill = color; text.style.opacity = 1; text.textContent = label;
      
      let start = null, pausedTime = 0;
      function tick(t) {
        if(isPaused) { if(!start) start=t; pausedTime = t-start; requestAnimationFrame(tick); return; }
        if(!start) start=t;
        const progress = Math.min((t-start-pausedTime)/(duration*SPEED_FACTOR), 1);
        const pt = path.getPointAtLength(progress * len);
        body.setAttribute('cx', pt.x); body.setAttribute('cy', pt.y);
        text.setAttribute('x', pt.x); text.setAttribute('y', pt.y+4);
        if(progress < 1) requestAnimationFrame(tick); else resolve();
      }
      requestAnimationFrame(tick);
    });
  }

  function closeModal() {
    modal.classList.remove('show-modal');
    setTimeout(()=> {
        modal.style.display='none';
        finalOverlay.style.display = 'flex';
    }, 300);
  }

  function showModal(title, msg, items, footer, isError) {
    modal.style.display = 'flex';
    $('modal-title').innerText = title;
    $('modal-title').style.color = isError ? 'var(--danger)' : 'var(--bg-page)';
    $('modal-msg').innerText = msg;
    const list = $('modal-details');
    list.innerHTML = '';
    items.forEach(i => { const li = document.createElement('li'); li.innerHTML = i; list.appendChild(li); });
    $('modal-footer').innerText = footer;
    setTimeout(()=> modal.classList.add('show-modal'), 10);
  }

  async function runSimulation() {
    isRunning = true;
    $('btn-run').disabled = true;
    $('mode-std').disabled = true;
    $('mode-zama').disabled = true;
    resetVisuals();

    try {
      if(currentMode === 'std') {
        explain("Step 1: User sends plaintext (5, 10).");
        log("User inputting plaintext [5, 10].", "normal");
        $('node-usr').querySelector('rect').classList.add('active-std');
        await wait(800);
        
        log("Broadcasting transaction to mempool...", "err");
        await movePacket('l-std', '5,10', '#ff4d4d', 1500);
        $('node-usr').querySelector('rect').classList.remove('active-std');
        
        $('node-host').querySelector('rect').classList.add('active-std');
        log("Miner picking up transaction.", "err");
        explain("Step 2: Host Chain computes 5+10 publicly.");
        await wait(1000);
        $('host-st').innerText = "State: 15 (VISIBLE)";
        log("Host Chain executed op: ADD(5, 10).", "err");
        log("Result '15' written to public storage.", "err");
        await wait(500);
        
        $('packet-body').style.opacity = 0; $('packet-text').style.opacity = 0;
        
        showModal(
          "Public Transaction Complete", 
          "Process Summary:", 
          [
            "User broadcast <b>plaintext</b> (5, 10) to the network.",
            "Validators executed the addition <b>publicly</b>.",
            "The result <b>'15'</b> is permanently visible on the ledger.",
            "<b>MEV Risk:</b> High. <b>Privacy:</b> None."
          ], 
          "Result: Everyone knows '15'.", 
          true
        );

      } else {
        // ZAMA FLOW
        
        explain("Phase 1: Input & Verification.");
        log("User generating ephemeral keys...", "zama");
        $('node-usr').querySelector('rect').classList.add('active-zama');
        await wait(500);
        log("Encrypting inputs [5, 10] -> [ct1, ct2].", "zama");
        await wait(500);
        log("Generating ZK Proof of Knowledge (ZKPoK).", "zama");
        
        await movePacket('l-usr-rel', 'Enc+ZK', '#ffd503', 800);
        $('node-usr').querySelector('rect').classList.remove('active-zama');
        
        $('node-rel').querySelector('rect').classList.add('active-mid');
        log("Relayer accepted packet. Paying gas fees.", "normal");
        await wait(500);
        
        log("Relayer forwarding ZK Proofs to Gateway.", "normal");
        await movePacket('l-rel-gw', 'ZK Proof', '#ff9f1c', 800);
        
        $('node-gw').querySelector('rect').classList.add('active-zama');
        log("Gateway verifying ZK Proofs...", "zama");
        $('gw-st').innerText = "Verifying...";
        await wait(800);
        $('gw-st').innerText = "Verified";
        log("Proofs Valid. Signing attestation.", "zama");
        $('node-gw').querySelector('rect').classList.remove('active-zama');
        
        log("Relayer submitting transaction to Host Chain.", "normal");
        await movePacket('l-rel-host', 'Tx', '#fff', 1000);
        $('node-rel').querySelector('rect').classList.remove('active-mid');
        
        $('node-host').querySelector('rect').classList.add('active-zama');
        explain("Phase 2: Encrypted Execution.");
        log("Host Chain executing smart contract...", "zama");
        $('host-st').innerText = "Handle: 0x8a...";
        log("Host encountered encrypted handle. Emitting Event.", "zama");
        await wait(800);
        
        await movePacket('l-host-cp', 'Event', '#007aff', 1000);
        $('node-host').querySelector('rect').classList.remove('active-zama');
        
        $('node-cp').querySelector('rect').classList.add('active-zama');
        log("Coprocessors picked up event.", "normal");
        log("Computing: FHE_ADD(ct1, ct2)...", "zama");
        $('cp-bar').setAttribute('width', 180); $('cp-bar').style.transition = "width 2s";
        await wait(1500);
        
        log("Computation complete. Result Ciphertext generated.", "zama");
        log("Committing result digest to Gateway.", "normal");
        await movePacket('l-cp-gw', 'Digest', '#00ff9d', 1000);
        $('node-cp').querySelector('rect').classList.remove('active-zama');
        
        explain("Phase 3: Threshold Decryption.");
        $('node-gw').querySelector('rect').classList.add('active-zama');
        log("Gateway checking ACL (Access Control List).", "zama");
        await wait(500);
        log("Requesting decryption from KMS Cluster.", "zama");
        await movePacket('l-gw-kms', 'Req', '#ff0055', 800);
        
        $('node-kms').querySelector('rect').classList.add('active-zama');
        log("KMS Node 1 verifying request...", "zama");
        $('s1').style.fill = '#00ff9d'; await wait(200);
        log("KMS Node 2 verifying request...", "zama");
        $('s2').style.fill = '#00ff9d'; await wait(200);
        log("KMS Node 3 verifying request...", "zama");
        $('s3').style.fill = '#00ff9d'; await wait(200);
        
        log("Threshold met. Computing partial decryptions.", "zama");
        await wait(800);
        
        log("Gateway aggregating partial shares.", "zama");
        $('gw-st').innerText = "Result: 15";
        $('node-kms').querySelector('rect').classList.remove('active-zama');
        
        explain("Phase 4: Delivery.");
        log("Gateway sending plaintext to Oracle.", "normal");
        await movePacket('l-gw-orc', '15', '#ff9f1c', 800);
        $('node-gw').querySelector('rect').classList.remove('active-zama');
        
        $('node-orc').querySelector('rect').classList.add('active-mid');
        log("Oracle preparing Callback Transaction.", "normal");
        await wait(500);
        await movePacket('l-orc-host', 'Callback', '#ff9f1c', 1000);
        $('node-orc').querySelector('rect').classList.remove('active-mid');
        
        $('node-host').querySelector('rect').classList.add('active-zama');
        log("Host Chain updated with decrypted result.", "zama");
        await wait(500);
        $('packet-body').style.opacity = 0; $('packet-text').style.opacity = 0;
        
        showModal(
          "Secure Execution Complete", 
          "Process Summary:", 
          [
            "<b>Distributed Key Gen:</b> Master key never exists in one place.",
            "<b>Relayer:</b> Abstracted gas and connectivity for user.",
            "<b>Gateway:</b> Verified ZK proofs before execution.",
            "<b>Coprocessors:</b> Performed math on encrypted data.",
            "<b>KMS:</b> Collaborated to decrypt result (Threshold).",
            "<b>Oracle:</b> Delivered plaintext '15' back to Host Chain."
          ], 
          "Result: You see '15'.", 
          false
        );
      }
    } catch(e) { console.error(e); alert("Error: "+e.message); }
    finally { 
      if(currentMode === 'std' && !$('result-modal').classList.contains('show-modal')) {
          // Edge case for error or interruption
          isRunning = false; 
          $('btn-run').disabled = false; 
          $('btn-run').innerText = "RESET & RUN AGAIN";
          $('mode-std').disabled = false;
          $('mode-zama').disabled = false;
      }
    }
  }

  return { setMode, runSimulation, togglePause, closeModal, resetApp };
})();
</script>
</body>
</html>
