<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
<title>Zama fhEVM Simulator - v33 Human Voice</title>
<style>
  :root {
    /* COLORS */
    --bg-page: #ffd503; 
    --panel-dark: #151a23;
    --node-bg: rgba(20, 20, 25, 0.98);
    
    --zama-blue: #007aff;
    --danger: #ff4d4d;
    --neon-green: #00ff9d;
    --neon-orange: #ff9f1c; 
    
    --font: 'Inter', system-ui, -apple-system, sans-serif;
  }
  
  * { box-sizing: border-box; }

  html, body {
    margin: 0; padding: 0;
    background: var(--bg-page); color: #000; 
    font-family: var(--font); 
    height: 100%; height: 100dvh; 
    overflow: hidden; display: flex; flex-direction: column; 
  }
  
  /* HEADER */
  header { 
    flex-shrink: 0; padding: 0 20px; border-bottom: 3px solid #000; 
    display: flex; justify-content: space-between; align-items: center; 
    background: var(--bg-page); z-index: 1000; height: 60px;
    padding-top: env(safe-area-inset-top); 
  }
  
  .branding { display: flex; align-items: center; gap: 8px; flex: 1; }
  .zama-logo { height: 30px; width: auto; mix-blend-mode: multiply; border: 1px solid rgba(0,0,0,0.1); }
  h1 { margin: 0; font-size: 18px; font-weight: 900; letter-spacing: -0.5px; text-transform: uppercase; white-space: nowrap; }

  /* DISCLAIMER */
  .disclaimer {
    flex: 2; text-align: center; font-size: 11px; line-height: 1.2; color: #333;
    border-left: 1px solid rgba(0,0,0,0.1); border-right: 1px solid rgba(0,0,0,0.1);
    padding: 0 10px; font-weight: 500; display: block;
  }
  .disclaimer a { color: #000; font-weight: 800; text-decoration: underline; }
  
  /* BUTTONS */
  .mode-wrapper { flex: 1; display: flex; justify-content: flex-end; }
  .mode-switch { display: flex; background: rgba(0,0,0,0.1); border: 2px solid #000; border-radius: 20px; padding: 3px; gap: 3px; }
  .mode-btn { 
    padding: 6px 12px; border-radius: 16px; font-size: 11px; font-weight: 800; cursor: pointer; 
    transition: all 0.2s; color: #555; border: none; background: transparent; outline: none; text-transform: uppercase;
  }
  .mode-btn:hover { color: #000; background: rgba(255,255,255,0.4); }
  .mode-btn.active-std { background: var(--danger); color: #fff; }
  .mode-btn.active-zama { background: #000; color: var(--bg-page); }
  .mode-btn:disabled { opacity: 0.5; filter: grayscale(1); cursor: not-allowed; }

  /* MAIN LAYOUT */
  .layout { 
    display: grid; 
    grid-template-columns: 1fr 400px; 
    flex: 1; min-height: 0; overflow: hidden; 
  }
  
  /* CANVAS */
  .canvas-wrapper { 
    position: relative; background: radial-gradient(circle at 50% 50%, #2a2a2a 0%, #000000 100%); 
    overflow: hidden; border-right: 4px solid #000; display: flex; align-items: center; justify-content: center;
  }
  svg { width: 100%; height: 100%; pointer-events: none; } 
  
  /* TEACHING OVERLAY */
  .teaching-box {
    position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
    background: #000; border: 2px solid var(--bg-page); padding: 8px 20px; 
    border-radius: 12px; width: 90%; max-width: 600px; text-align: center; 
    box-shadow: 0 5px 20px rgba(0,0,0,0.8); z-index: 50;
  }
  .teaching-title { color: var(--bg-page); font-size: 10px; font-weight: 900; margin-bottom: 2px; }
  .teaching-text { color: #fff; font-size: 14px; line-height: 1.2; font-weight: 600; }

  /* CONTROLS */
  .controls { 
    background: var(--panel-dark); padding: 20px; display: flex; flex-direction: column; 
    gap: 15px; z-index: 60; border-left: 4px solid #000; overflow: hidden; 
  }
  .step-card { background: #000; padding: 12px; border-radius: 8px; border: 1px solid #333; flex-shrink: 0; }
  .step-title { font-size: 12px; font-weight: 700; color: #fff; margin-bottom: 5px; }
  .step-desc { font-size: 11px; color: #ccc; line-height: 1.3; }
  
  .btn-control-row { display: flex; gap: 10px; flex-shrink: 0; }
  button.action-btn { 
    background: #333; border: 1px solid #555; padding: 14px; border-radius: 8px; 
    color: #fff; font-weight: 800; cursor: pointer; transition: transform 0.1s; width: 100%; font-size: 13px; text-transform: uppercase;
  }
  button.btn-zama { background: var(--bg-page); color: #000; border: 2px solid #000; }
  button.btn-std { background: var(--danger); color: #fff; border: 2px solid #000; }
  
  /* AUDIO BUTTON */
  button.btn-audio { background: #222; color: #777; border: 1px solid #555; }
  button.btn-audio.on { background: var(--neon-green); color: #000; border: 2px solid #000; box-shadow: 0 0 8px var(--neon-green); }

  button.btn-pause { background: #fff; color:#000; border: 2px solid #000; }
  button.btn-pause.paused { background: #000; color: #fff; animation: blink 1s infinite; }
  @keyframes blink { 0%{opacity:1} 50%{opacity:0.7} 100%{opacity:1} }
  
  button:hover { transform: translateY(-2px); filter: brightness(1.1); }
  button:disabled { background: #333; color: #777; filter: grayscale(1); border-color: #444; cursor: not-allowed; }

  /* LOG TERMINAL */
  .log-terminal { 
    flex: 1; background: #000; border-radius: 8px; border: 1px solid #333; 
    padding: 12px; font-family: 'Courier New', monospace; font-size: 13px; line-height: 1.4; color: var(--neon-green); overflow-y: auto; 
  }
  .log-entry { margin-bottom: 6px; border-bottom: 1px solid #222; padding-bottom: 3px; }
  .highlight-red { color: var(--danger); font-weight: bold; }
  .highlight-yellow { color: var(--bg-page); font-weight: bold; }

  /* SVG TEXT */
  .txt-label { fill: #fff; font-size: 16px; font-weight: 800; font-family: sans-serif; pointer-events: none; }
  .txt-detail { fill: #aaa; font-size: 12px; font-family: monospace; pointer-events: none; }
  .packet-text { fill: #fff; font-size: 12px; font-weight: 900; pointer-events: none; text-shadow: 0 1px 3px rgba(0,0,0,0.8); }

  /* FOOTER */
  footer {
    flex-shrink: 0; background: #000; color: #888; padding: 8px; text-align: center;
    font-size: 10px; border-top: 2px solid #222; z-index: 100;
    padding-bottom: env(safe-area-inset-bottom); 
  }
  footer a { color: var(--bg-page); text-decoration: none; font-weight: 700; }
  .heart { color: var(--danger); font-size: 12px; vertical-align: middle; }

  /* RESPONSIVE OVERRIDES */
  @media (max-width: 900px) {
    h1 { font-size: 14px; } 
    .disclaimer { display: none; } 
    .branding { gap: 6px; }
    .zama-logo { height: 24px; }
    
    .layout { grid-template-columns: 1fr; grid-template-rows: 50% 1fr; }
    .canvas-wrapper { border-right: none; border-bottom: 4px solid #000; }
    
    .controls { border-left: none; padding: 10px; gap: 8px; }
    .step-card { display: none; } 
    .log-terminal { font-size: 11px; }
    .btn-control-row { gap: 5px; }
    button.action-btn { padding: 10px; font-size: 11px; }
    .txt-label { font-size: 18px; } 
    .txt-detail { font-size: 14px; }
    
    .teaching-box { 
        top: 5px; 
        width: 96%; 
        padding: 5px 10px;
        background: rgba(0,0,0,0.85); 
    }
    .teaching-title { display: none; } 
    .teaching-text { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  }

  /* SVG STYLES */
  .node-rect { fill: var(--node-bg); stroke: #555; stroke-width: 2; transition: all 0.3s; }
  
  .node-rect.active-zama { stroke: var(--bg-page); stroke-width: 4; fill: rgba(255, 213, 3, 0.15); filter: drop-shadow(0 0 12px rgba(255, 213, 3, 0.6)); }
  .node-rect.active-std { stroke: var(--danger); stroke-width: 4; fill: rgba(255, 77, 77, 0.15); filter: drop-shadow(0 0 12px rgba(255, 77, 77, 0.6)); }
  .node-rect.active-mid { stroke: var(--neon-orange); stroke-width: 3; fill: rgba(255, 159, 28, 0.15); filter: drop-shadow(0 0 10px rgba(255, 159, 28, 0.5)); }
  .node-rect.active-host-exec { stroke: #fff; stroke-width: 4; fill: rgba(255,255,255,0.2); filter: drop-shadow(0 0 15px rgba(255,255,255,0.5)); }

  .packet { stroke: #fff; stroke-width: 3; opacity: 0; }
  .link { fill: none; stroke: #444; stroke-width: 2; stroke-dasharray: 6 6; opacity: 0.2; }
  .link.relevant { opacity: 1; stroke: #888; }

  /* MODALS */
  .modal-overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9); backdrop-filter: blur(5px); display: none; 
    justify-content: center; align-items: center; z-index: 99999; 
  }
  .modal-content {
    background: #151a23; border: 4px solid var(--bg-page); border-radius: 16px; 
    width: 90%; max-width: 500px; max-height: 85vh; padding: 25px; 
    display: flex; flex-direction: column; box-shadow: 0 0 50px rgba(0,0,0,0.8); 
  }
  .modal-header { font-size: 20px; font-weight: 800; margin-bottom: 10px; color: #fff; flex-shrink: 0; }
  .modal-body { font-size: 14px; line-height: 1.6; color: #ddd; overflow-y: auto; padding-right: 5px; }
  .modal-body p { margin-bottom: 15px; }
  .modal-list { margin-top: 10px; padding-left: 20px; border-left: 3px solid #555; }
  .modal-list li { margin-bottom: 8px; }
  .modal-btn { margin-top: 15px; padding: 12px; font-size: 12px; font-weight: 900; border-radius: 8px; cursor: pointer; background: var(--bg-page); border: none; }
  
  #final-overlay { background: rgba(0,0,0,0.85); display: none; flex-direction: column; z-index: 99990; }
  .final-btn { padding: 15px 30px; font-size: 16px; font-weight: 900; background: transparent; border: 3px solid var(--bg-page); color: var(--bg-page); border-radius: 50px; cursor: pointer; }
</style>
</head>
<body>

<header>
  <div class="branding">
    <img src="logo.jpg" alt="Logo" class="zama-logo" onerror="this.style.backgroundColor='white'" />
    <h1>Zama <span>FHEVM Simulator</span></h1>
  </div>
  <div class="disclaimer">Based on <a href="https://github.com/zama-ai/fhevm/blob/main/fhevm-whitepaper.pdf" target="_blank">Zama Whitepaper</a>. Simplified for edu. There might be mistakes in the simulation. I just tried to show what I understood.</div>
  <div class="mode-wrapper">
    <div class="mode-switch">
      <button id="mode-std" class="mode-btn" onclick="window.setMode('std')">Other EVM</button>
      <button id="mode-zama" class="mode-btn active-zama" onclick="window.setMode('zama')">Zama FHEVM</button>
    </div>
  </div>
</header>

<div class="layout">
  <div class="canvas-wrapper">
    <div class="teaching-box" id="teach-box">
      <div class="teaching-title">STATUS</div>
      <div class="teaching-text" id="teach-text">Idle. Enable Voice for Narration.</div>
    </div>

    <svg id="simSvg" viewBox="0 0 1000 900" preserveAspectRatio="xMidYMid meet">
      <defs>
        <marker id="arrow" markerWidth="10" markerHeight="10" refX="8" refY="3" orient="auto" markerUnits="strokeWidth"><path d="M0,0 L0,6 L9,3 z" fill="#888" /></marker>
      </defs>
      <g transform="translate(0, 120)">
        <path id="l-usr-rel" class="link relevant" d="M100 550 L 200 550" />
        <path id="l-rel-gw" class="link relevant" d="M300 550 L 480 550" />
        <path id="l-rel-host" class="link relevant" d="M250 510 C 250 200, 150 200, 150 180" />
        <path id="l-host-cp" class="link relevant" d="M250 130 L 580 130" />
        <path id="l-cp-gw" class="link relevant" d="M680 180 L 680 320 L 650 350" />
        <path id="l-gw-kms" class="link relevant" d="M650 500 L 800 500" />
        <path id="l-gw-orc" class="link relevant" d="M480 450 L 300 420" />
        <path id="l-orc-host" class="link relevant" d="M250 380 C 250 300, 150 300, 150 180" />
        <path id="l-std" class="link" d="M100 550 C 100 150, 100 150, 150 150" />
        <g id="node-host" transform="translate(50, 80)"><rect class="node-rect" width="200" height="100" rx="4" /><text x="20" y="40" class="txt-label">Host</text><text id="host-st" x="20" y="70" class="txt-detail">State: -</text></g>
        <g id="node-cp" transform="translate(580, 80)"><rect class="node-rect" width="220" height="100" rx="4" /><text x="20" y="40" class="txt-label">Coprocessors</text><rect id="cp-bar" x="20" y="70" width="0" height="6" fill="#00ff9d" /></g>
        <g id="node-gw" transform="translate(480, 400)"><rect class="node-rect" width="180" height="150" rx="4" /><text x="20" y="40" class="txt-label">Gateway</text><text id="gw-st" x="20" y="70" class="txt-detail">Idle</text></g>
        <g id="node-kms" transform="translate(800, 480)"><rect class="node-rect" width="160" height="100" rx="4" style="stroke-dasharray:4 4"/><text x="15" y="30" class="txt-label">KMS</text><g transform="translate(10,50)"><circle id="s1" r="8" fill="#333"/><circle id="s2" cx="30" r="8" fill="#333"/><circle id="s3" cx="60" r="8" fill="#333"/></g></g>
        <g id="node-rel" transform="translate(200, 510)"><rect class="node-rect" width="100" height="80" rx="4" style="stroke:var(--neon-orange)" /><text x="15" y="45" class="txt-label" style="fill:var(--neon-orange)">Relayer</text></g>
        <g id="node-orc" transform="translate(200, 350)"><rect class="node-rect" width="100" height="80" rx="4" style="stroke:var(--neon-orange)" /><text x="15" y="45" class="txt-label" style="fill:var(--neon-orange)">Oracle</text></g>
        <g id="node-usr" transform="translate(20, 510)"><rect class="node-rect" width="80" height="80" rx="8" /><text x="20" y="45" class="txt-label">User</text></g>
        <g id="packet-group"><circle id="packet-body" class="packet" cx="0" cy="0" r="24" /><text id="packet-text" class="packet-text" x="0" y="5">Tx</text></g>
      </g>
    </svg>
  </div>

  <div class="controls">
    <div id="desc-box">
      <div class="step-card">
        <div id="step-title" class="step-title" style="color:var(--bg-page)">ZAMA FHEVM MODE</div>
        <div id="step-desc" class="step-desc">User > Relayer > Gateway > Host > Coprocessor > Gateway > KMS > Oracle.</div>
      </div>
    </div>
    <div class="btn-control-row">
      <button id="btn-audio" class="action-btn btn-audio" onclick="window.toggleAudio()">ðŸ”‡ VOICE OFF</button>
      <button id="btn-pause" class="action-btn btn-pause" onclick="window.togglePause()">PAUSE</button>
      <button id="btn-run" class="action-btn btn-zama" onclick="window.runSimulation()">START</button>
    </div>
    <div class="log-terminal" id="logger"><div class="log-entry">System Ready. Enable Voice for narration.</div></div>
  </div>
</div>

<footer>
  Built with <span class="heart">â™¥</span> for <a href="https://zama.ai" target="_blank">ZAMA</a> &nbsp;|&nbsp; 
  Dev: <a href="https://x.com/lemonar777" target="_blank">@lemonar777</a>
</footer>

<div id="result-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header" id="modal-title">Title</div>
    <div class="modal-body">
      <div id="modal-desc-content"></div>
      <ul class="modal-list" id="modal-details"></ul>
      <p id="modal-footer" style="margin-top:15px; font-weight:bold; color:#fff; border-top:1px solid #444; padding-top:10px;"></p>
    </div>
    <button class="modal-btn" id="modal-close" onclick="window.closeModal()">CLOSE</button>
  </div>
</div>

<div id="final-overlay" class="modal-overlay">
  <div class="final-content">
    <div class="final-title" style="color:var(--bg-page); margin-bottom:20px; font-size:24px; font-weight:900;">SIMULATION DONE</div>
    <button class="final-btn" onclick="window.resetApp()">RESET</button>
  </div>
</div>

<script>
window.isRunning = false;
window.isPaused = false;
window.isVoiceOn = false; 
window.currentMode = 'zama';
const SPEED_FACTOR = 1.8;

const $ = id => document.getElementById(id);

// --- VOICE LOGIC ---
window.toggleAudio = function() {
  window.isVoiceOn = !window.isVoiceOn;
  const btn = $('btn-audio');
  if(window.isVoiceOn) {
    btn.innerHTML = "ðŸ”Š VOICE ON";
    btn.classList.add('on');
    speak("Voice narration enabled.");
  } else {
    btn.innerHTML = "ðŸ”‡ VOICE OFF";
    btn.classList.remove('on');
    window.speechSynthesis.cancel();
  }
};

function getBestMaleVoice() {
    const voices = window.speechSynthesis.getVoices();
    // Prioritize known high-quality male/deep voices
    return voices.find(v => v.name.includes('Google US English') || v.name.includes('David') || v.name.includes('Daniel') || (v.lang.includes('en') && v.name.includes('Male'))) 
           || voices.find(v => v.lang.includes('en'));
}

function speak(text) {
  if(!window.isVoiceOn) return;
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  const voice = getBestMaleVoice();
  if(voice) u.voice = voice;
  
  u.pitch = 0.9; // Deeper tone (Humanly Male)
  u.rate = 1.05; // Natural Conversational Speed
  u.volume = 1.0;
  
  window.speechSynthesis.speak(u);
}

// Initialize voices on load
window.speechSynthesis.onvoiceschanged = function() { getBestMaleVoice(); };


/* --- SYNC LOGIC --- */
async function executeStep(visualFn, logs) {
    const fullText = logs.join(". ");
    if(window.isVoiceOn) speak(fullText);

    // Determine time based on log length (ensures voice finishes)
    const duration = window.isVoiceOn ? Math.max(2000, fullText.length * 65) : 2000; 

    for(const line of logs) {
        log(line, window.currentMode === 'zama' ? 'zama' : 'normal');
        $('teach-text').innerText = line; // Sync status bar
        await wait(300);
    }

    await visualFn(duration);
    await wait(500);
}

function safeAddClass(id, cls) {
  const el = $(id);
  if(el && el.querySelector('rect')) el.querySelector('rect').classList.add(cls);
  else if(el) el.classList.add(cls);
}

function safeRemoveClass(id, cls) {
  const el = $(id);
  if(el && el.querySelector('rect')) el.querySelector('rect').classList.remove(cls);
  else if(el) el.classList.remove(cls);
}

window.togglePause = function() {
  if(!window.isRunning) return;
  window.isPaused = !window.isPaused;
  const btn = $('btn-pause');
  btn.innerHTML = window.isPaused ? "RESUME" : "PAUSE";
  btn.classList.toggle('paused', window.isPaused);
  if(window.isPaused) window.speechSynthesis.pause();
  else window.speechSynthesis.resume();
};

window.setMode = function(m) {
  if(window.isRunning) return;
  window.currentMode = m;
  $('mode-std').className = `mode-btn ${m==='std'?'active-std':''}`;
  $('mode-zama').className = `mode-btn ${m==='zama'?'active-zama':''}`;
  
  const btn = $('btn-run');
  if(m==='std') {
    btn.className = 'action-btn btn-std';
    btn.innerText = "START PUBLIC";
    $('step-title').style.color = "var(--danger)";
    $('step-title').innerText = "PUBLIC BLOCKCHAIN";
    $('step-desc').innerText = "Transparent data. No privacy. High risk. Everyone can see the results.";
  } else {
    btn.className = 'action-btn btn-zama';
    btn.innerText = "START ZAMA";
    $('step-title').style.color = "var(--bg-page)";
    $('step-title').innerText = "ZAMA FHEVM";
    $('step-desc').innerText = "Full encrypted flow. Highly secure. Only the use can see data.";
  }
  window.resetVisuals();
};

window.resetVisuals = function() {
  $('logger').innerHTML = '';
  $('host-st').innerText = "State: -";
  $('gw-st').innerText = "Idle";
  $('cp-bar').setAttribute('width', 0);
  document.querySelectorAll('.node-rect').forEach(el => el.classList.remove('active-zama','active-std','active-mid', 'active-host-exec'));
  $('packet-body').style.opacity = 0;
  $('packet-text').style.opacity = 0;
  ['s1','s2','s3'].forEach(id => $(id).style.fill = '#333');
};

window.resetApp = function() {
  $('final-overlay').style.display = 'none';
  window.isRunning = false;
  $('btn-run').disabled = false;
  $('btn-run').innerText = "START";
  $('mode-std').disabled = false;
  $('mode-zama').disabled = false;
  window.resetVisuals();
  $('teach-text').innerText = "Ready.";
};

function log(msg, type) {
  const div = document.createElement('div');
  div.className = 'log-entry';
  if(type==='err') div.style.color = 'var(--danger)';
  if(type==='zama') div.style.color = 'var(--bg-page)';
  const time = new Date().toLocaleTimeString().split(' ')[0];
  div.innerHTML = `<span style="color:#555; font-size:0.8em;">[${time}]</span> ${msg}`;
  $('logger').appendChild(div);
  $('logger').scrollTop = $('logger').scrollHeight;
}

function wait(ms) {
  return new Promise(resolve => {
    const total = ms; 
    let elapsed = 0;
    const timer = setInterval(() => {
      if(!window.isPaused) elapsed += 50;
      if(elapsed >= total) { clearInterval(timer); resolve(); }
    }, 50);
  });
}

function movePacket(pathId, label, color, duration=2000) {
  return new Promise(resolve => {
    const path = $(pathId);
    if(!path) { resolve(); return; }
    const len = path.getTotalLength();
    const body = $('packet-body');
    const text = $('packet-text');
    body.style.opacity = 1; body.style.fill = color; text.style.opacity = 1; text.textContent = label;
    let start = null, pausedTime = 0;
    function tick(t) {
      if(window.isPaused) { if(!start) start=t; pausedTime = t-start; requestAnimationFrame(tick); return; }
      if(!start) start=t;
      const progress = Math.min((t-start-pausedTime)/duration, 1);
      const pt = path.getPointAtLength(progress * len);
      body.setAttribute('cx', pt.x); body.setAttribute('cy', pt.y);
      text.setAttribute('x', pt.x); text.setAttribute('y', pt.y+4);
      if(progress < 1) requestAnimationFrame(tick); else resolve();
    }
    requestAnimationFrame(tick);
  });
}

window.closeModal = function() {
  $('result-modal').classList.remove('show-modal');
  setTimeout(()=> {
      $('result-modal').style.display='none';
      $('final-overlay').style.display = 'flex';
  }, 300);
};

function showModal(title, htmlContent, items, footer, isError) {
  const m = $('result-modal');
  m.style.display = 'flex';
  $('modal-title').innerText = title;
  $('modal-title').style.color = isError ? 'var(--danger)' : 'var(--bg-page)';
  $('modal-desc-content').innerHTML = htmlContent;
  const list = $('modal-details');
  list.innerHTML = '';
  items.forEach(i => { const li = document.createElement('li'); li.innerHTML = i; list.appendChild(li); });
  $('modal-footer').innerText = footer;
  setTimeout(()=> m.classList.add('show-modal'), 10);
}

window.runSimulation = async function() {
  window.isRunning = true;
  $('btn-run').disabled = true;
  $('mode-std').disabled = true;
  $('mode-zama').disabled = true;
  window.resetVisuals();

  try {
    if(window.currentMode === 'std') {
      await executeStep(async (dur) => {
        safeAddClass('node-usr', 'active-std');
        await movePacket('l-std', '5,10', '#ff4d4d', dur);
        safeRemoveClass('node-usr', 'active-std');
      }, ["User initiating standard transaction", "Packing plaintext payload [5, 10]", "Signing with private key", "Broadcasting to public mempool"]);

      await executeStep(async (dur) => {
        safeAddClass('node-host', 'active-std');
        await wait(dur);
      }, ["Miner picked up transaction", "Host Chain executing ADD(5, 10)", "Verifying logic: 5 + 10 = 15", "Writing result to public ledger"]);

      $('host-st').innerText = "State: 15 (VISIBLE)";
      $('packet-body').style.opacity = 0; $('packet-text').style.opacity = 0;

      const publicDesc = `<p>In a standard transaction, data is sent in plaintext. Miners see the data to verify logic (5+10=15). Zero privacy. Vulnerable to MEV.</p>`;
      showModal("Public Tx Complete", publicDesc, ["Plaintext Broadcast.", "Public Execution.", "Result Exposed."], "Result: 15", true);

    } else {
      // 1. ENCRYPT
      await executeStep(async (dur) => {
        safeAddClass('node-usr', 'active-zama');
        await movePacket('l-usr-rel', 'Enc+ZK', '#ffd503', dur);
        safeRemoveClass('node-usr', 'active-zama');
      }, ["Generating ephemeral encryption keys", "Encrypting Input A: 5 -> ct_0x8a", "Encrypting Input B: 10 -> ct_0x9b", "Generating Zero-Knowledge Proof (ZKPoK)", "Sending payload to Relayer"]);

      // 2. RELAY
      await executeStep(async (dur) => {
        safeAddClass('node-rel', 'active-mid');
        await movePacket('l-rel-gw', 'ZK Proof', '#ff9f1c', dur);
        safeRemoveClass('node-rel', 'active-mid');
      }, ["Relayer received packet", "Estimating gas fees for transaction", "Bundling transaction for submission", "Forwarding ZK Proofs to Gateway"]);

      // 3. GATEWAY VERIFY
      await executeStep(async (dur) => {
        safeAddClass('node-gw', 'active-zama');
        $('gw-st').innerText = "Verifying...";
        await wait(dur);
        $('gw-st').innerText = "Verified";
        safeRemoveClass('node-gw', 'active-zama');
      }, ["Gateway received ZK Proofs", "Validating cryptographic signatures", "Checking ciphertext integrity", "Proof Valid. Signing attestation"]);

      // 4. SUBMIT TO HOST
      await executeStep(async (dur) => {
        await movePacket('l-rel-host', 'Tx', '#fff', dur);
      }, ["Relayer received attestation", "Submitting transaction to Host Chain", "paying gas on behalf of user"]);

      // 5. HOST EXECUTION
      await executeStep(async (dur) => {
        safeAddClass('node-host', 'active-host-exec');
        $('host-st').innerText = "Handle: 0x8a...";
        await wait(dur/2);
        await movePacket('l-host-cp', 'Event', '#007aff', dur/2);
        safeRemoveClass('node-host', 'active-host-exec');
      }, ["Host Chain executing Smart Contract", "Encountered Encrypted Handle (ct_0x8a)", "Logic: FHE_ADD(Handle A, Handle B)", "Emitting 'Computation Request' Event"]);

      // 6. COPROCESSOR
      await executeStep(async (dur) => {
        safeAddClass('node-cp', 'active-zama');
        $('cp-bar').setAttribute('width', 180); $('cp-bar').style.transition = `width ${dur}ms`;
        await wait(dur);
        await movePacket('l-cp-gw', 'Digest', '#00ff9d', 1500);
        safeRemoveClass('node-cp', 'active-zama');
      }, ["Coprocessors detected event", "Fetching encrypted data from storage", "Performing Homomorphic Addition (Blind)", "Generating Result Ciphertext", "Committing Result Digest to Gateway"]);

      // 7. DECRYPT
      await executeStep(async (dur) => {
        safeAddClass('node-gw', 'active-zama');
        await movePacket('l-gw-kms', 'Req', '#ff0055', 1000);
        safeAddClass('node-kms', 'active-zama');
        ['s1','s2','s3'].forEach(id => $(id).style.fill = '#00ff9d');
        await wait(dur);
        safeRemoveClass('node-kms', 'active-zama');
        $('gw-st').innerText = "Result: 15";
        safeRemoveClass('node-gw', 'active-zama');
      }, ["Gateway verifying computation digest", "Checking Access Control List (ACL)", "Requesting Threshold Decryption from KMS", "KMS Shards validating request", "Aggregating partial decryption shares"]);

      // 8. ORACLE DELIVERY
      await executeStep(async (dur) => {
        await movePacket('l-gw-orc', '15', '#ff9f1c', 1000);
        safeAddClass('node-orc', 'active-mid');
        await wait(500);
        await movePacket('l-orc-host', 'Callback', '#ff9f1c', 1000);
        safeRemoveClass('node-orc', 'active-mid');
        safeAddClass('node-host', 'active-zama');
        $('host-st').innerText = "State: 15 (Encrypted)";
        await wait(1000);
      }, ["Gateway sending plaintext to Oracle", "Oracle creating Callback Transaction", "Submitting result back to Host Chain", "Host Chain state updated successfully"]);

      $('packet-body').style.opacity = 0; $('packet-text').style.opacity = 0;

      const zamaDesc = `<p><b>How Zama fhEVM Works:</b> Transaction was end-to-end encrypted. User inputs (5, 10) were encrypted locally. Host Chain processed "Handles" (references). Coprocessors computed math on ciphertext blindly.</p><p>Result revealed via Threshold Protocol (KMS). Oracle bridged result back. Data remained confidential throughout.</p>`;
      
      showModal("Secure Execution Complete", zamaDesc, ["Encryption: Inputs hidden via ZK.", "Blind Compute: Math on ciphertexts.", "KMS: Threshold Decryption.", "Oracle: Trustless bridge."], "Result: 15", false);
    }
  } catch(e) { console.error(e); alert("Error: "+e.message); }
  finally { 
    if(window.currentMode === 'std' && !$('result-modal').classList.contains('show-modal')) {
        window.isRunning = false; $('btn-run').disabled = false; $('btn-run').innerText = "RESET";
    }
  }
};
</script>
</body>
</html>


